{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://blert.io/schemas/bcf-1.0-strict.schema.json",
  "title": "Blert Chart Format (BCF) 1.0 Strict",
  "type": "object",
  "additionalProperties": false,
  "required": ["version", "config", "timeline"],
  "properties": {
    "version": { "const": "1.0" },
    "name": { "type": "string" },
    "description": { "type": "string" },
    "config": { "$ref": "#/$defs/config" },
    "timeline": { "$ref": "#/$defs/timeline" },
    "augmentation": { "$ref": "#/$defs/augmentation" }
  },

  "$defs": {
    "idString": {
      "type": "string",
      "pattern": "^[A-Za-z0-9_-]+$",
      "description": "URL-safe identifier (alphanumeric, underscore, hyphen)."
    },

    "config": {
      "type": "object",
      "additionalProperties": false,
      "required": ["totalTicks"],
      "properties": {
        "totalTicks": { "type": "integer", "minimum": 1 },
        "startTick": { "type": "integer", "minimum": 0 },
        "endTick": { "type": "integer", "minimum": 0 },
        "rowOrder": {
          "type": "array",
          "items": { "$ref": "#/$defs/idString" },
          "uniqueItems": true,
          "minItems": 1
        },
        "definitions": { "$ref": "#/$defs/definitions" }
      }
    },

    "definitions": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "attacks": { "type": "string", "format": "uri" },
        "spells": { "type": "string", "format": "uri" },
        "npcAttacks": { "type": "string", "format": "uri" }
      }
    },

    "timeline": {
      "type": "object",
      "additionalProperties": false,
      "required": ["actors", "ticks"],
      "properties": {
        "actors": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/actor" }
        },
        "ticks": {
          "type": "array",
          "items": { "$ref": "#/$defs/tick" }
        }
      }
    },

    "actor": {
      "oneOf": [
        { "$ref": "#/$defs/playerActor" },
        { "$ref": "#/$defs/npcActor" }
      ]
    },

    "playerActor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "id", "name"],
      "properties": {
        "type": { "const": "player" },
        "id": { "$ref": "#/$defs/idString" },
        "name": { "type": "string", "minLength": 1 }
      }
    },

    "npcActor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "id", "npcId", "name"],
      "properties": {
        "type": { "const": "npc" },
        "id": { "$ref": "#/$defs/idString" },
        "npcId": { "type": "integer", "minimum": 1 },
        "name": { "type": "string", "minLength": 1 }
      }
    },

    "tick": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tick", "cells"],
      "properties": {
        "tick": { "type": "integer", "minimum": 0 },
        "cells": {
          "type": "array",
          "items": { "$ref": "#/$defs/cell" }
        }
      }
    },

    "cell": {
      "type": "object",
      "additionalProperties": false,
      "required": ["actorId"],
      "properties": {
        "actorId": { "$ref": "#/$defs/idString" },
        "actions": { "$ref": "#/$defs/actions" },
        "state": { "$ref": "#/$defs/state" }
      }
    },

    "actions": {
      "type": "array",
      "items": { "$ref": "#/$defs/action" }
    },

    "action": {
      "oneOf": [
        { "$ref": "#/$defs/attackAction" },
        { "$ref": "#/$defs/spellAction" },
        { "$ref": "#/$defs/deathAction" },
        { "$ref": "#/$defs/npcAttackAction" }
      ]
    },

    "attackAction": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "attackType"],
      "properties": {
        "type": { "const": "attack" },
        "attackType": { "type": "string", "minLength": 1 },
        "weaponId": { "type": "integer", "minimum": 1 },
        "weaponName": { "type": "string" },
        "targetActorId": { "$ref": "#/$defs/idString" },
        "distanceToTarget": { "type": "integer", "minimum": 0 },
        "specCost": { "type": "integer", "minimum": 0, "maximum": 100 },
        "display": { "$ref": "#/$defs/attackDisplay" }
      }
    },

    "spellAction": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "spellType"],
      "properties": {
        "type": { "const": "spell" },
        "spellType": { "type": "string", "minLength": 1 },
        "targetActorId": { "$ref": "#/$defs/idString" },
        "display": { "$ref": "#/$defs/spellDisplay" }
      }
    },

    "deathAction": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": { "const": "death" }
      }
    },

    "npcAttackAction": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "attackType"],
      "properties": {
        "type": { "const": "npcAttack" },
        "attackType": { "type": "string", "minLength": 1 },
        "targetActorId": { "$ref": "#/$defs/idString" },
        "display": { "$ref": "#/$defs/npcAttackDisplay" }
      }
    },

    "attackDisplay": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "iconUrl": { "type": "string" },
        "letter": { "type": "string", "minLength": 1, "maxLength": 3 },
        "style": { "enum": ["melee", "ranged", "magic"] }
      }
    },

    "spellDisplay": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "iconUrl": { "type": "string" },
        "name": { "type": "string" }
      }
    },

    "npcAttackDisplay": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "iconUrl": { "type": "string" },
        "description": { "type": "string" }
      }
    },

    "state": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "isDead": { "type": "boolean" },
        "offCooldown": { "type": "boolean" },
        "specEnergy": { "type": "integer", "minimum": 0, "maximum": 100 },
        "label": { "type": "string" },
        "customStates": {
          "type": "array",
          "items": { "$ref": "#/$defs/customState" }
        }
      }
    },

    "customState": {
      "type": "object",
      "additionalProperties": false,
      "anyOf": [{ "required": ["label"] }, { "required": ["iconUrl"] }],
      "properties": {
        "label": { "type": "string", "minLength": 1, "maxLength": 4 },
        "fullText": { "type": "string" },
        "iconUrl": { "type": "string" }
      }
    },

    "augmentation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "splits": {
          "type": "array",
          "items": { "$ref": "#/$defs/split" }
        },
        "backgroundColors": {
          "type": "array",
          "items": { "$ref": "#/$defs/backgroundColor" }
        },
        "customRows": {
          "type": "array",
          "items": { "$ref": "#/$defs/customRow" }
        }
      }
    },

    "split": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tick", "name"],
      "properties": {
        "tick": { "type": "integer", "minimum": 0 },
        "name": { "type": "string", "minLength": 1 },
        "isImportant": { "type": "boolean", "default": true }
      }
    },

    "backgroundColor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tick", "color"],
      "properties": {
        "tick": { "type": "integer", "minimum": 0 },
        "length": { "type": "integer", "minimum": 1, "default": 1 },
        "color": {
          "type": "string",
          "pattern": "^#([0-9a-fA-F]{6}|[0-9a-fA-F]{8})$"
        },
        "rowIds": {
          "type": "array",
          "items": { "$ref": "#/$defs/idString" },
          "minItems": 1,
          "uniqueItems": true
        }
      }
    },

    "customRow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "cells"],
      "properties": {
        "id": { "$ref": "#/$defs/idString" },
        "name": { "type": "string", "minLength": 1 },
        "cells": {
          "type": "array",
          "items": { "$ref": "#/$defs/customRowCell" }
        }
      }
    },

    "customRowCell": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tick"],
      "properties": {
        "tick": { "type": "integer", "minimum": 0 },
        "iconUrl": { "type": "string" },
        "label": { "type": "string", "minLength": 1, "maxLength": 3 },
        "opacity": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 1.0
        }
      },
      "anyOf": [{ "required": ["iconUrl"] }, { "required": ["label"] }]
    }
  }
}
